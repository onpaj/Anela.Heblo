name: 🧹 Cleanup

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

jobs:
  cleanup-artifacts:
    name: 🗑️ Cleanup Artifacts
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🗑️ Delete old artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const { data: artifacts } = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });

            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 30); // Keep artifacts for 30 days

            for (const artifact of artifacts.artifacts) {
              const createdAt = new Date(artifact.created_at);
              if (createdAt < cutoffDate) {
                console.log(`Deleting artifact: ${artifact.name} (created: ${artifact.created_at})`);
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
              }
            }

  cleanup-docker-images:
    name: 🐳 Cleanup Docker Images
    runs-on: ubuntu-latest
    steps:
      - name: 🔐 Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: 🗑️ Delete old test images
        run: |
          echo "🔍 Fetching Docker Hub tags..."
          
          # Get all tags for the repository
          REPO="${{ secrets.DOCKER_USERNAME }}/anela-heblo"
          
          # This is a simplified cleanup - in production, you'd use Docker Hub API
          # to delete old test-* and ci-* tags that are older than X days
          echo "ℹ️ Manual Docker Hub cleanup may be needed for old test and CI images"
          echo "Consider implementing Docker Hub API calls to clean up tags older than 30 days"