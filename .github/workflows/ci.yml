name: ðŸ”„ Continuous Integration (Optimized)

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  REGISTRY: docker.io
  IMAGE_NAME: heblo

jobs:
  # Frontend CI - Test and build only (no lint)
  frontend-ci:
    name: ðŸŽ¯ Frontend CI (Test + Build)
    runs-on: ubuntu-latest
    outputs:
      has-build-artifact: ${{ steps.check-build.outputs.has-artifact }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: ./frontend
        run: npm install --legacy-peer-deps

      - name: ðŸ§ª Run tests with coverage
        working-directory: ./frontend
        run: npm test -- --coverage --watchAll=false
        env:
          CI: true

      - name: ðŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v3
        continue-on-error: true
        with:
          files: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

      - name: ðŸ—ï¸ Build production bundle
        working-directory: ./frontend
        run: npm run build
        env:
          REACT_APP_API_URL: https://placeholder.azurewebsites.net
          REACT_APP_USE_MOCK_AUTH: false

      - name: âœ… Check build success
        id: check-build
        run: echo "has-artifact=true" >> $GITHUB_OUTPUT

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/build/
          retention-days: 7

  # Backend CI - Test and build only (no lint)
  backend-ci:
    name: ðŸŽ¯ Backend CI (Test + Build)
    runs-on: ubuntu-latest
    outputs:
      has-build-artifact: ${{ steps.check-build.outputs.has-artifact }}
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: ðŸ“¦ Restore dependencies
        run: dotnet restore Anela.Heblo.sln

      - name: ðŸ§ª Run tests with coverage
        run: dotnet test Anela.Heblo.sln --collect:"XPlat Code Coverage" --logger trx --results-directory ./coverage

      - name: ðŸ“Š Upload coverage reports
        uses: codecov/codecov-action@v3
        continue-on-error: true
        with:
          files: ./coverage/*/coverage.cobertura.xml
          flags: backend
          name: backend-coverage

      - name: ðŸ—ï¸ Build solution
        run: dotnet build Anela.Heblo.sln --configuration Release --no-restore

      - name: âœ… Check build success
        id: check-build
        run: echo "has-artifact=true" >> $GITHUB_OUTPUT

  # UI Tests with Playwright - runs in parallel with docker build (non-blocking)
  playwright-tests:
    name: ðŸŽ­ UI Tests (Playwright)
    runs-on: ubuntu-latest
    needs: [frontend-ci, backend-ci]
    continue-on-error: true
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Restore .NET dependencies
        run: dotnet restore backend/src/Anela.Heblo.API/Anela.Heblo.API.csproj

      - name: ðŸ“¦ Install frontend dependencies
        working-directory: ./frontend
        run: npm install --legacy-peer-deps

      - name: ðŸŽ­ Install Playwright browsers
        working-directory: ./frontend
        run: npx playwright install --with-deps chromium

      - name: ðŸš€ Start automation backend
        run: |
          cd backend/src/Anela.Heblo.API
          ASPNETCORE_ENVIRONMENT=Automation dotnet run --launch-profile Automation &
          echo "BACKEND_PID=$!" >> $GITHUB_ENV
        env:
          ASPNETCORE_ENVIRONMENT: Automation

      - name: â³ Wait for backend to start
        run: |
          echo "Waiting for backend to start on port 5001..."
          timeout 60 bash -c 'until curl -f http://localhost:5001/health > /dev/null 2>&1; do sleep 2; done'
          echo "Backend is ready!"

      - name: ðŸš€ Start automation frontend
        working-directory: ./frontend
        run: |
          npm run start:automation &
          echo "FRONTEND_PID=$!" >> $GITHUB_ENV
        env:
          REACT_APP_API_URL: http://localhost:5001
          REACT_APP_USE_MOCK_AUTH: true

      - name: â³ Wait for frontend to start
        run: |
          echo "Waiting for frontend to start on port 3001..."
          timeout 60 bash -c 'until curl -f http://localhost:3001 > /dev/null 2>&1; do sleep 2; done'
          echo "Frontend is ready!"

      - name: ðŸ§ª Run Playwright tests
        working-directory: ./frontend
        run: npx playwright test
        env:
          CI: true

      - name: ðŸ“¤ Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 7

      - name: ðŸ“¤ Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-test-results
          path: frontend/test-results/
          retention-days: 7

      - name: ðŸ§¹ Cleanup processes
        if: always()
        run: |
          echo "Cleaning up background processes..."
          if [ ! -z "$BACKEND_PID" ]; then
            kill $BACKEND_PID 2>/dev/null || true
          fi
          if [ ! -z "$FRONTEND_PID" ]; then
            kill $FRONTEND_PID 2>/dev/null || true
          fi
          # Kill any remaining processes on the test ports
          lsof -ti:5001 | xargs kill -9 2>/dev/null || true
          lsof -ti:3001 | xargs kill -9 2>/dev/null || true
          echo "Cleanup completed"

  # Docker Build - depends on both frontend and backend CI
  docker-build:
    name: ðŸ³ Docker Build
    runs-on: ubuntu-latest
    needs: [frontend-ci, backend-ci]
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ—ï¸ Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ${{ env.IMAGE_NAME }}:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Quality Gate - ensures all jobs pass
  quality-gate:
    name: âœ… Quality Gate
    runs-on: ubuntu-latest
    needs: [frontend-ci, backend-ci, playwright-tests, docker-build]
    if: always()
    steps:
      - name: âœ… Check all jobs succeeded
        run: |
          echo "Frontend CI: ${{ needs.frontend-ci.result }}"
          echo "Backend CI: ${{ needs.backend-ci.result }}"
          echo "Playwright Tests: ${{ needs.playwright-tests.result }}"
          echo "Docker Build: ${{ needs.docker-build.result }}"
          
          # Check required jobs (always run)
          if [[ "${{ needs.frontend-ci.result }}" != "success" || \
                "${{ needs.backend-ci.result }}" != "success" || \
                "${{ needs.docker-build.result }}" != "success" ]]; then
            echo "âŒ Quality gate failed - required jobs failed"
            exit 1
          fi
          
          # Playwright tests are optional - show status but don't fail CI
          if [[ "${{ needs.playwright-tests.result }}" == "failure" ]]; then
            echo "âš ï¸ Playwright tests failed (non-blocking)"
          elif [[ "${{ needs.playwright-tests.result }}" == "success" ]]; then
            echo "âœ… Playwright tests passed"
          fi
          
          echo "âœ… Quality gate passed - all required jobs succeeded"

      - name: ðŸ“‹ Generate CI summary
        run: |
          echo "## ðŸŽ‰ CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Frontend CI**: Test, Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **Backend CI**: Test, Build completed successfully" >> $GITHUB_STEP_SUMMARY  
          
          # Dynamic UI Tests status (non-blocking)
          if [[ "${{ needs.playwright-tests.result }}" == "success" ]]; then
            echo "âœ… **UI Tests**: Playwright tests passed successfully" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.playwright-tests.result }}" == "failure" ]]; then
            echo "âš ï¸ **UI Tests**: Playwright tests failed (non-blocking)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "âœ… **Docker Build**: Image built successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸš€ **Ready for deployment!**" >> $GITHUB_STEP_SUMMARY

  # Auto-merge job - runs when quality gate passes and PR has auto-merge label
  auto-merge:
    name: ðŸ¤– Auto-merge PR
    runs-on: ubuntu-latest
    needs: [quality-gate]
    if: |
      github.event.pull_request.draft == false &&
      contains(github.event.pull_request.labels.*.name, 'auto-merge')
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ”„ Enable auto-merge
        run: |
          echo "Enabling auto-merge for PR #${{ github.event.pull_request.number }}"
          gh pr merge ${{ github.event.pull_request.number }} \
            --auto \
            --squash \
            --delete-branch
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ’¬ Comment on PR
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "ðŸš€ **Auto-merge enabled!**
          
          All CI checks have passed successfully:
          - âœ… Frontend tests and build
          - âœ… Backend tests and build  
          - âœ… UI tests (Playwright)
          - âœ… Docker build
          
          This PR will be automatically merged when all required status checks are complete.
          
          _Note: Branch will be deleted after merge._"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}