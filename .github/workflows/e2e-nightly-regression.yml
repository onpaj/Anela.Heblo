name: ðŸŽ­ E2E Nightly Regression Tests

on:
  # Scheduled - Every night at 2:00 AM CET (1:00 AM UTC)
  schedule:
    - cron: '0 1 * * *'  # 1:00 AM UTC = 2:00 AM CET

  # Manual trigger with optional test pattern filter
  workflow_dispatch:
    inputs:
      test_pattern:
        description: 'Test pattern (e.g., "catalog" or "auth", leave empty for all E2E tests)'
        required: false
        default: ''
        type: string
      browser:
        description: 'Browser to run tests on'
        required: false
        default: 'chromium'
        type: choice
        options:
          - 'chromium'
          - 'firefox'
          - 'webkit'
          - 'all'

env:
  STAGING_URL: https://heblo.stg.anela.cz
  NODE_VERSION: '18'

# Required permissions for test reporter to create check runs
permissions:
  checks: write      # Allow creating check runs for test results
  contents: read     # Allow reading repository contents

jobs:
  # Validate staging health before running tests
  validate-staging-health:
    name: ðŸ¥ Validate Staging Health
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“Š Check Liveness Endpoint
        id: liveness
        run: |
          echo "ðŸ” Checking liveness endpoint..."
          http_code=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.STAGING_URL }}/health/live")

          if [ "$http_code" = "200" ]; then
            echo "âœ… Liveness check passed"
            echo "liveness_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Liveness check failed with status $http_code"
            echo "liveness_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ðŸ“Š Check Readiness Endpoint
        id: readiness
        run: |
          echo "ðŸ” Checking readiness endpoint..."
          http_code=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.STAGING_URL }}/health/ready")

          if [ "$http_code" = "200" ]; then
            echo "âœ… Readiness check passed"
            echo "readiness_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Readiness check failed with status $http_code"
            echo "readiness_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ðŸ“Š Check General Health Endpoint
        id: health
        run: |
          echo "ðŸ” Checking general health endpoint..."
          http_code=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.STAGING_URL }}/health")

          if [ "$http_code" = "200" ]; then
            echo "âœ… General health check passed"
            echo "health_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ General health check failed with status $http_code"
            echo "health_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ðŸ“ Health Check Summary
        run: |
          echo "## ðŸ¥ Staging Health Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Liveness | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| Readiness | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| General Health | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— **Staging URL:** ${{ env.STAGING_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ• **Validated at:** $(date)" >> $GITHUB_STEP_SUMMARY

  # Run E2E tests against staging with parallel module execution
  run-e2e-tests:
    name: ðŸŽ­ Run E2E Tests (${{ matrix.module }})
    runs-on: ubuntu-latest
    needs: validate-staging-health
    strategy:
      fail-fast: false
      matrix:
        module:
          - catalog
          - issued-invoices
          - stock-operations
          - transport
          - manufacturing
          - core

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ðŸ“¦ Install dependencies
        working-directory: ./frontend
        run: npm install --legacy-peer-deps

      - name: ðŸŽ­ Install Playwright browsers
        working-directory: ./frontend
        run: |
          # Always install chromium for modular execution
          npx playwright install --with-deps chromium

      - name: ðŸ“‚ List E2E test files for module
        working-directory: ./frontend
        run: |
          echo "ðŸ” Test files in module '${{ matrix.module }}':"
          find test/e2e/${{ matrix.module }} -name "*.spec.ts" -type f | sort
          echo ""
          echo "ðŸ“Š Test count: $(find test/e2e/${{ matrix.module }} -name "*.spec.ts" -type f | wc -l)"

      - name: ðŸ” Validate Azure credentials
        working-directory: ./frontend
        run: |
          if [ -z "${{ secrets.E2E_CLIENT_ID }}" ] || [ -z "${{ secrets.E2E_CLIENT_SECRET }}" ]; then
            echo "âŒ E2E Azure credentials are not configured!"
            echo "Required secrets: E2E_CLIENT_ID, E2E_CLIENT_SECRET"
            exit 1
          fi
          echo "âœ… Azure credentials validated"

      - name: ðŸ§ª Run E2E tests for module
        id: run-tests
        working-directory: ./frontend
        continue-on-error: true
        run: |
          # Run tests for specific module
          npx playwright test --project=${{ matrix.module }}
        env:
          PLAYWRIGHT_BASE_URL: ${{ env.STAGING_URL }}
          CI: true
          # Azure service principal credentials for E2E authentication
          E2E_CLIENT_ID: ${{ secrets.E2E_CLIENT_ID }}
          E2E_CLIENT_SECRET: ${{ secrets.E2E_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.REACT_APP_AZURE_TENANT_ID }}

      - name: ðŸ“Š Publish Test Results to GitHub
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: 'ðŸŽ­ E2E Test Results - ${{ matrix.module }}'
          path: 'frontend/test-results/junit.xml'
          reporter: 'java-junit'
          fail-on-error: false
          fail-on-empty: false

      - name: ðŸ“Š Upload E2E test results and HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results-${{ matrix.module }}-${{ github.run_number }}
          path: |
            frontend/test-results/
            frontend/playwright-report/
          retention-days: 30

      - name: ðŸ“¸ Upload E2E screenshots (failures only)
        uses: actions/upload-artifact@v4
        if: always() && steps.run-tests.outcome == 'failure'
        with:
          name: e2e-failure-screenshots-${{ matrix.module }}-${{ github.run_number }}
          path: frontend/test-results/
          retention-days: 30

      - name: ðŸ“ Create E2E test summary
        if: always()
        run: |
          echo "## ðŸŽ­ E2E Test Results - ${{ matrix.module }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Parse JSON results
          if [ -f frontend/test-results/results.json ]; then
            FAILED=$(jq '[ .suites[].suites[]?.specs[]? | select(.ok == false) ] | length' frontend/test-results/results.json 2>/dev/null || echo "0")
            SKIPPED=$(jq '[ .suites[].suites[]?.specs[]? | select(.tests[0].results[0].status == "skipped") ] | length' frontend/test-results/results.json 2>/dev/null || echo "0")

            # Show failed tests
            if [ "$FAILED" -gt 0 ]; then
              echo "âŒ **Failed: $FAILED**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # Extract failed test details
              jq -r '[ .suites[].suites[]?.specs[]? | select(.ok == false) ] | .[] | "**" + .title + "**\n- File: `" + .file + "`\n- Error: " + (.tests[0].results[0].error.message // "No error message") + "\n"' frontend/test-results/results.json >> $GITHUB_STEP_SUMMARY
            fi

            # Show skipped tests
            if [ "$SKIPPED" -gt 0 ]; then
              echo "â­ï¸ **Skipped: $SKIPPED**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # Extract skipped test names
              jq -r '[ .suites[].suites[]?.specs[]? | select(.tests[0].results[0].status == "skipped") ] | .[] | "- " + .title' frontend/test-results/results.json >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            # If all passed, show nothing (clean output)
            if [ "$FAILED" -eq 0 ] && [ "$SKIPPED" -eq 0 ]; then
              echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
            fi
          fi

  # Aggregate results from all modules
  aggregate-results:
    name: ðŸ“Š Aggregate Test Results
    runs-on: ubuntu-latest
    needs: run-e2e-tests
    if: always()

    steps:
      - name: ðŸ“¥ Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: e2e-test-results-*
          path: all-results

      - name: ðŸ“Š Aggregate and display results
        run: |
          echo "## ðŸŽ­ E2E Nightly Regression - Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Initialize counters
          TOTAL_TESTS=0
          TOTAL_PASSED=0
          TOTAL_FAILED=0
          TOTAL_SKIPPED=0

          # Aggregate results from all modules
          for dir in all-results/e2e-test-results-*/; do
            if [ -f "$dir/test-results/results.json" ]; then
              MODULE_TOTAL=$(jq '[ .suites[].suites[]?.specs[]? ] | length' "$dir/test-results/results.json" 2>/dev/null || echo "0")
              MODULE_PASSED=$(jq '[ .suites[].suites[]?.specs[]? | select(.ok == true) ] | length' "$dir/test-results/results.json" 2>/dev/null || echo "0")
              MODULE_FAILED=$(jq '[ .suites[].suites[]?.specs[]? | select(.ok == false) ] | length' "$dir/test-results/results.json" 2>/dev/null || echo "0")
              MODULE_SKIPPED=$(jq '[ .suites[].suites[]?.specs[]? | select(.tests[0].results[0].status == "skipped") ] | length' "$dir/test-results/results.json" 2>/dev/null || echo "0")

              TOTAL_TESTS=$((TOTAL_TESTS + MODULE_TOTAL))
              TOTAL_PASSED=$((TOTAL_PASSED + MODULE_PASSED))
              TOTAL_FAILED=$((TOTAL_FAILED + MODULE_FAILED))
              TOTAL_SKIPPED=$((TOTAL_SKIPPED + MODULE_SKIPPED))
            fi
          done

          # Display overall status
          if [ "$TOTAL_FAILED" -eq 0 ]; then
            echo "âœ… **All tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **$TOTAL_FAILED test(s) failed.**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Display aggregate metrics
          echo "### ðŸ“Š Overall Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Total Tests** | $TOTAL_TESTS |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… **Passed** | $TOTAL_PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ **Failed** | $TOTAL_FAILED |" >> $GITHUB_STEP_SUMMARY
          if [ "$TOTAL_SKIPPED" -gt 0 ]; then
            echo "| â­ï¸ **Skipped** | $TOTAL_SKIPPED |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ðŸ“¦ Module Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Detailed results for each module are available in their respective job summaries above." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # List modules
          echo "**Modules executed:**" >> $GITHUB_STEP_SUMMARY
          echo "- catalog" >> $GITHUB_STEP_SUMMARY
          echo "- issued-invoices" >> $GITHUB_STEP_SUMMARY
          echo "- stock-operations" >> $GITHUB_STEP_SUMMARY
          echo "- transport" >> $GITHUB_STEP_SUMMARY
          echo "- manufacturing" >> $GITHUB_STEP_SUMMARY
          echo "- core" >> $GITHUB_STEP_SUMMARY
